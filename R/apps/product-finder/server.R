library(shiny)
library(logging)
library(DT)
library(glue)
library(lubridate)
library(ggrepel)


source("../api.R")
source("../visualisations.R")

.update.slider <- function(data, session, field) {
    max <- data %>% pull(field) %>% max(na.rm = TRUE)
    min <-
        data %>% pull(field) %>% min(na.rm = TRUE)
    
    logdebug("min: {min}, max: {max}" %>% glue)
    
    updateSliderInput(
        session,
        field,
        max = max,
        min = min,
        value = c(min, max)
    )
}

shinyServer(function(input, output, session) {
    basicConfig(level = 10)
    loginfo("initializing...")
    
    data <- load.data() %>%
        filter(`Date` == max(`Date`),!is.na(ParentCategory)) %>%
        cluster.data() %>%
        mutate(Gravity_Change = replace(Gravity_Change, is.infinite(Gravity_Change), 100)) %>%
        mutate(Gravity_Change = replace_na(Gravity_Change, 0),) %>%
        mutate(Gravity_Change = round(Gravity_Change * 100, 1)) %>%
        mutate(Gravity_Change_Pct = if_else(
            Gravity_Change > 0,
            if_else(
                Gravity_Change >= 10000,
                ">>+{Gravity_Change} %" %>% glue(),
                "+{Gravity_Change} %" %>% glue()
            ),
            "{Gravity_Change} %" %>% glue()
        ))
    
    
    logdebug(data %>% nrow())
    
    .update.slider(data, session, "Gravity")
    .update.slider(data, session, "Gravity_Change")
    .update.slider(data, session, "PopularityRank")
    .update.slider(data, session, "AverageEarningsPerSale")
    .update.slider(data, session, "InitialEarningsPerSale")
    .update.slider(data, session, "PercentPerRebill")
    .update.slider(data, session, "PercentPerSale")
    .update.slider(data, session, "TotalRebillAmt")
    .update.slider(data, session, "Referred")
    .update.slider(data, session, "Commission")
    .update.slider(data, session, "ActivateDate")
    
    
    loginfo("initializing.")
    
    pca.brushed.data <- reactive({
        brushedPoints(
            data,
            brush = input$pca.plot.brush,
            xvar = "PC1",
            yvar = "PC2"
        )
    })
    
    gravity.gravity.change.brushed.data <- reactive({
        filtered.data <- brushedPoints(
            data,
            brush = input$gravity.gravity.change.brush,
            xvar = "Gravity",
            yvar = "Gravity_Change"
        )
        if (filtered.data %>% nrow == 0) {
            filtered.data <- data
        }
        
        filtered.data
    })
    
    
    
    filtered.data <- reactive({
        result <- data %>%
            filter(Gravity >= input$Gravity[1] &
                       Gravity <= input$Gravity[2]) %>%
            filter(
                Gravity_Change >= input$Gravity_Change[1] &
                    Gravity_Change <= input$Gravity_Change[2]
            ) %>%
            filter(
                AverageEarningsPerSale >= input$AverageEarningsPerSale[1] &
                    AverageEarningsPerSale <= input$AverageEarningsPerSale[2]
            ) %>%
            filter(
                InitialEarningsPerSale >= input$InitialEarningsPerSale[1] &
                    InitialEarningsPerSale <= input$InitialEarningsPerSale[2]
            ) %>%
            filter(
                PercentPerRebill >= input$PercentPerRebill[1] &
                    PercentPerRebill <= input$PercentPerRebill[2]
            ) %>%
            filter(
                PercentPerSale >= input$PercentPerSale[1] &
                    PercentPerSale <= input$PercentPerSale[2]
            ) %>%
            filter(
                TotalRebillAmt >= input$TotalRebillAmt[1] &
                    TotalRebillAmt <= input$TotalRebillAmt[2]
            ) %>%
            filter(
                PopularityRank >= input$PopularityRank[1] &
                    PopularityRank <= input$PopularityRank[2]
            )  %>%
            filter(
                ActivateDate >= as.Date(input$ActivateDate[1]) &
                    ActivateDate <= as.Date(input$ActivateDate[2])
            ) %>%
            filter(Referred >= input$Referred[1] &
                       Referred <= input$Referred[2]) %>%
            filter(Commission >= input$Commission[1] &
                       Commission <= input$Commission[2])
        result
    })
    
    
    
    output$products.filtered <-
        renderDataTable(
            filtered.data() %>%
                mutate(Cluster = as.factor(kmeans.cluster)) %>%
                select(
                    Id,
                    #Date,
                    Title,
                    ActivateDate,
                    PopularityRank,
                    Gravity,
                    Gravity_Change_Pct,
                    AverageEarningsPerSale,
                    InitialEarningsPerSale
                    
                )
        )
    
    output$products.brushed <-
        renderDataTable(
            pca.brushed.data() %>%
                mutate(Cluster = as.factor(kmeans.cluster)) %>%
                select(
                    Id,
                    Cluster,
                    Title,
                    #Date,
                    ActivateDate,
                    PopularityRank,
                    Gravity,
                    Gravity_Change_Pct,
                    AverageEarningsPerSale,
                    InitialEarningsPerSale
                )
        )
    
    output$gravityPlot <- renderPlot({
        filtered.data() %>%
            plot.gravity.averageenarningspersale()
        
    })
    
    output$dummy <- renderPlot({
        NULL
    })
    
    output$gravity.gravity.change.plot <- renderPlot({
        gravity.gravity.change.brushed.data() %>%
            plot.gravity.gravity.change()
    })
    
    output$pcaPlot <- renderPlot({
        data %>%
            mutate(cluster = as.factor(kmeans.cluster)) %>%
            arrange(-Gravity, -AverageEarningsPerSale) %>%
            plot.cluster.scatter()
    })
    
    output$pcaPlotMagnifier <- renderPlot({
        data <- pca.brushed.data()
        data %>%
            mutate(Title = as.character(Title)) %>%
            mutate(selected.title = if_else(
                Gravity %in%
                    (data %>%
                         arrange(desc(Gravity)) %>%
                         head(10) %>% pull(Gravity)),
                Title,
                ""
            )) %>%
            plot.magnifier()
    })
    
    
    output
    
})